generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Business {
  id           String   @id @default(cuid())
  name         String
  location     String?
  contactEmail String?
  phone        String?
  address      String?
  timezone           String?         @default("Pacific/Auckland")
  currency           String?         @default("NZD")
  logoUrl            String?
  defaultPaymentMethod PaymentMethod? @default(CASH)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users        User[]
  customers    Customer[]
  instructors  Instructor[]
  equipment    Equipment[]
  equipmentCategories  EquipmentCategory[]
  equipmentVariants    EquipmentVariant[]
  lessons      Lesson[]
  bookings     Booking[]
  rentals      Rental[]
  payments     Payment[]
  integrations Integration[]
}

model User {
  id           String    @id @default(cuid())
  business     Business  @relation(fields: [businessId], references: [id])
  businessId   String

  name         String
  email        String    @unique
  passwordHash String
  role         UserRole  @default(STAFF)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

enum UserRole {
  OWNER
  STAFF
}

model Customer {
  id         String    @id @default(cuid())
  business   Business  @relation(fields: [businessId], references: [id])
  businessId String

  firstName  String
  lastName   String
  phone      String?
  email      String?
  dob        DateTime?
  notes      String?
  archivedAt DateTime?

  bookings   Booking[]
  rentals    Rental[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Instructor {
  id         String    @id @default(cuid())
  business   Business  @relation(fields: [businessId], references: [id])
  businessId String

  firstName  String
  lastName   String
  phone      String?
  email      String?
  hourlyRate Decimal?  @db.Decimal(10,2)
  isActive   Boolean   @default(true)

  lessons    Lesson[]
  bookings   Booking[]

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
}

model Equipment {
  id          String    @id @default(cuid())
  business    Business  @relation(fields: [businessId], references: [id])
  businessId  String

  category    String
  size        String?
  description String?
  hourlyPrice Decimal   @db.Decimal(10,2)
  status      EquipmentStatus @default(AVAILABLE)

  rentals     Rental[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum EquipmentStatus {
  AVAILABLE
  RENTED
  MAINTENANCE
}

model Lesson {
  id          String    @id @default(cuid())
  business    Business  @relation(fields: [businessId], references: [id])
  businessId  String

  instructor  Instructor? @relation(fields: [instructorId], references: [id])
  instructorId String?

  title       String
  price       Decimal   @db.Decimal(10,2)
  capacity    Int?
  durationMinutes Int @default(60)

  bookings    Booking[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Booking {
  id          String    @id @default(cuid())
  business    Business  @relation(fields: [businessId], references: [id])
  businessId  String

  customer    Customer  @relation(fields: [customerId], references: [id])
  customerId  String

  instructor  Instructor? @relation(fields: [instructorId], references: [id])
  instructorId String?

  lesson      Lesson?   @relation(fields: [lessonId], references: [id])
  lessonId    String?
  rental      Rental?

  startAt     DateTime
  endAt       DateTime
  participants       Int @default(1)
  status             BookingStatus @default(BOOKED)
  externalReference  String?  // FareHarbor/Stripe booking ID

  equipmentAllocations BookingEquipmentAllocation[]

  payments    Payment[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model BookingEquipmentAllocation {
  id               String   @id @default(cuid())
  booking          Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  bookingId        String

  equipmentVariant EquipmentVariant @relation(fields: [equipmentVariantId], references: [id])
  equipmentVariantId String

  quantity         Int      @default(1)

  createdAt        DateTime @default(now())

  @@index([equipmentVariantId, bookingId])
}


enum BookingStatus {
  BOOKED
  CHECKED_IN
  COMPLETED
  CANCELLED
  NO_SHOW
}

model EquipmentCategory {
  id          String    @id @default(cuid())
  business    Business  @relation(fields: [businessId], references: [id])
  businessId  String

  name        String
  trackSizes  Boolean   @default(true)
  isActive    Boolean   @default(true)
  totalQuantity Int     @default(0)
  hourlyRate  Decimal?  @db.Decimal(10,2)

  variants    EquipmentVariant[]
  rentals     Rental[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([businessId, name])
}

model EquipmentVariant {
  id                 String    @id @default(cuid())
  business           Business  @relation(fields: [businessId], references: [id])
  businessId         String

  category           EquipmentCategory @relation(fields: [categoryId], references: [id])
  categoryId         String

  label              String
  totalQuantity      Int       @default(0)
  lowStockThreshold  Int       @default(2)
  isActive           Boolean   @default(true)

  rentals            Rental[]

  bookingAllocations BookingEquipmentAllocation[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([categoryId, label])
}

model Rental {
  id          String    @id @default(cuid())
  business    Business  @relation(fields: [businessId], references: [id])
  businessId  String

  customer    Customer  @relation(fields: [customerId], references: [id])
  customerId  String

  booking     Booking?  @relation(fields: [bookingId], references: [id])
  bookingId   String?   @unique

  equipmentCategory   EquipmentCategory? @relation(fields: [equipmentCategoryId], references: [id])
  equipmentCategoryId String?

  equipmentVariant   EquipmentVariant?  @relation(fields: [equipmentVariantId], references: [id])
  equipmentVariantId String?
  quantity           Int @default(1)

  equipment   Equipment? @relation(fields: [equipmentId], references: [id])
  equipmentId String?

  startAt       DateTime
  endAt         DateTime
  returnedAt    DateTime?
  priceTotal    Decimal?  @db.Decimal(10,2)
  status        RentalStatus @default(ACTIVE)

  payment   Payment?  @relation("RentalPayment")

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum RentalStatus {
  ACTIVE
  RETURNED
  OVERDUE
  CANCELLED
}

model Payment {
  id                 String         @id @default(cuid())
  business           Business       @relation(fields: [businessId], references: [id])
  businessId         String

  booking            Booking?      @relation(fields: [bookingId], references: [id])
  bookingId          String?

  rental             Rental?       @relation("RentalPayment", fields: [rentalId], references: [id])
  rentalId           String?       @unique

  amount             Decimal        @db.Decimal(10,2)
  currency           String         @default("NZD")
  method             PaymentMethod
  provider           PaymentProvider @default(MANUAL)
  status             PaymentStatus  @default(PAID)
  externalReference  String?
  paidAt             DateTime      @default(now())
  stripePaymentIntentId String?
  stripeSessionId    String?

  createdAt          DateTime      @default(now())
}

model Integration {
  id          String   @id @default(cuid())
  business    Business @relation(fields: [businessId], references: [id])
  businessId  String

  provider    IntegrationProvider
  config      String?  // JSON, encrypted at app layer
  isActive    Boolean  @default(false)
  lastSyncAt  DateTime?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([businessId, provider])
}

enum PaymentMethod {
  CASH
  EFTPOS
  CARD
  TRANSFER  // Legacy, prefer EFTPOS/CARD
  ONLINE
}

enum PaymentProvider {
  MANUAL
  FAREHARBOR
  STRIPE
}

enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum IntegrationProvider {
  FAREHARBOR
  STRIPE
}